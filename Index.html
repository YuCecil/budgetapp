<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™½èŠ±å˜‰éº—åª½è¨˜å¸³APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥æ¼‚äº®çš„åœ“æ½¤å­—é«” Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'], // é è¨­æ›¿æ›ç‚º Noto Sans
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.4s ease-out forwards',
                        'bounce-slight': 'bounceSlight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSlight: {
                            '0%': { opacity: '0', transform: 'scale(0.9) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            -webkit-tap-highlight-color: transparent;
        }

        input[type="month"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(1);
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* è®“äº¤éŒ¯å‹•ç•«ä¾åºé€²å…¥ */
        .stagger-1 {
            animation-delay: 50ms;
        }

        .stagger-2 {
            animation-delay: 100ms;
        }

        .stagger-3 {
            animation-delay: 150ms;
        }

        .stagger-4 {
            animation-delay: 200ms;
        }

        .stagger-5 {
            animation-delay: 250ms;
        }

        /* ç»ç’ƒè³ªæ„Ÿå…±ç”¨ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="bg-amber-50 text-gray-800 h-screen overflow-hidden selection:bg-amber-200 antialiased">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // ==========================================
        // è«‹å°‡æ‚¨çš„ Google Apps Script ç¶²å€è²¼åœ¨ä¸‹æ–¹å¼•è™Ÿä¸­
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQcuqkmZhXQHpJDGUOoOxWQhZXS_NhPAD0Trl7lGz4cbLJio9VasesWnjv2yTYqs_bfQ/exec";
        // ==========================================

        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icons = {
            Home: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            PieChart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 12 2.5 10"></path><path d="M12 12V2.5"></path><path d="M12 12 18 20"></path></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Sparkles: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Help: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            Copy: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Refresh: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Cloud: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>,
            Folder: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
        };

        const COLORS = ['#F59E0B', '#D97706', '#B45309', '#78350F', '#FCD34D', '#84CC16', '#10B981'];
        const formatNumber = (num) => new Intl.NumberFormat('zh-TW').format(num || 0); // é˜²å‘†: å¦‚æœæ˜¯ undefined å‰‡é¡¯ç¤º 0

        // --- Components ---
        const SimplePieChart = ({ data }) => {
            const [hovered, setHovered] = useState(null);
            // å„ªåŒ–ï¼šè®“åœ“é¤…åœ–çš„å€å¡Šä¾æ“šã€Œé‡‘é¡å¤§å°ã€æ’åºï¼Œç”±å¤§è‡³å°æ›´ç›´è¦º
            const sortedData = [...data].sort((a, b) => b.value - a.value);
            const total = sortedData.reduce((sum, item) => sum + item.value, 0);

            // å°‡ä½”æ¯”å¤ªå°çš„é …ç›®åˆä½µï¼Œé¿å…åœ–è¡¨æ“ åœ¨ä¸€èµ·ä¸å¥½çœ‹
            const threshold = total * 0.02; // < 2%
            const displayData = [];
            let otherValue = 0;

            sortedData.forEach(item => {
                if (item.value >= threshold) {
                    displayData.push(item);
                } else {
                    otherValue += item.value;
                }
            });

            if (otherValue > 0) {
                displayData.push({ name: 'å…¶ä»–å°é¡', value: otherValue });
            }

            let currentAngle = 0;

            if (total === 0) return <div className="text-center mt-20 text-gray-400 animate-fade-in-up"><div>æœ¬æœˆå°šç„¡èŠ±è²»</div></div>;

            return (
                <div className="flex flex-col items-center w-full max-w-xs mx-auto animate-fade-in-up">
                    <div className="relative w-64 h-64 mb-6">
                        <svg viewBox="-1.1 -1.1 2.2 2.2" style={{ transform: 'rotate(-90deg)' }} className="w-full h-full overflow-visible drop-shadow-md">
                            {displayData.map((item, index) => {
                                const percentage = item.value / total;
                                const sliceAngle = percentage * 2 * Math.PI;
                                if (displayData.length === 1) return <circle key={item.name} cx="0" cy="0" r="1" fill={COLORS[index % COLORS.length]} onClick={() => setHovered(index)} />;
                                const x1 = Math.cos(currentAngle); const y1 = Math.sin(currentAngle);
                                const x2 = Math.cos(currentAngle + sliceAngle); const y2 = Math.sin(currentAngle + sliceAngle);
                                const largeArc = sliceAngle > Math.PI ? 1 : 0;
                                const d = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                const path = <path key={item.name} d={d} fill={COLORS[index % COLORS.length]} stroke="#FFFBEB" strokeWidth="0.015" strokeLinejoin="round" onClick={() => setHovered(index)} onMouseEnter={() => setHovered(index)} onMouseLeave={() => setHovered(null)} style={{ transition: 'all 0.3s ease', opacity: hovered !== null && hovered !== index ? 0.6 : 1, transform: hovered === index ? 'scale(1.05)' : 'scale(1)', transformOrigin: 'center', cursor: 'pointer' }} />;
                                currentAngle += sliceAngle;
                                return path;
                            })}
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            {hovered !== null ? (
                                <div className="glass-panel shadow-xl text-amber-900 text-xs p-3 rounded-xl border border-amber-100 text-center animate-bounce-slight">
                                    <div className="font-bold text-sm mb-1">{displayData[hovered].name}</div>
                                    <div className="font-mono text-amber-600 font-bold text-base">${formatNumber(displayData[hovered].value)}</div>
                                    <div className="text-gray-400 mt-1">{Math.round(displayData[hovered].value / total * 100)}%</div>
                                </div>
                            ) : <div className="text-xs text-amber-700/50 font-medium flex flex-col items-center"><span>é»æ“Šå€å¡Š<br />æŸ¥çœ‹æ˜ç´°</span></div>}
                        </div>
                    </div>
                    <div className="flex flex-wrap gap-2 justify-center mt-2">
                        {displayData.map((item, index) => (
                            <div key={item.name} className={`flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full cursor-pointer transition-colors border ${hovered === index ? 'bg-amber-100 border-amber-300' : 'bg-white border-transparent'}`} onMouseEnter={() => setHovered(index)} onMouseLeave={() => setHovered(null)}>
                                <div className="w-3 h-3 rounded-full" style={{ background: COLORS[index % COLORS.length] }}></div>
                                <span className={hovered === index ? "font-bold text-amber-900" : "text-gray-600"}>{item.name}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ç¨ç«‹å‡ºä¾†çš„ HistoryViewï¼Œé¿å…åœ¨ App å…§éƒ¨å®šç¾©å°è‡´çš„æ¸²æŸ“å•é¡Œ
        const HistoryView = ({ history, currentMonth, onDelete }) => {
            // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœ history ä¸æ˜¯é™£åˆ—ï¼Œå‰‡è¦–ç‚ºç©ºé™£åˆ—ï¼Œé˜²æ­¢ç•¶æ©Ÿ
            const safeHistory = Array.isArray(history) ? history : [];

            return (
                <div className="p-4 pb-24 h-full overflow-y-auto">
                    <h2 className="text-xl font-bold mb-4 px-2 text-amber-900 flex items-center gap-2 animate-fade-in-up"><span>ğŸ“œ</span> {currentMonth} ç´€éŒ„</h2>
                    {safeHistory.length === 0 ? <div className="text-center text-gray-400 mt-20 flex flex-col gap-2 animate-fade-in-up stagger-1"><div className="text-4xl mb-2">ğŸƒ</div><span>æœ¬æœˆæš«ç„¡ç´€éŒ„ï¼Œä¾†è¨˜ä¸€ç­†å§ï¼</span></div> : (
                        <div className="space-y-3">
                            {safeHistory.map((record, index) => (
                                <div key={record.id || Math.random()} className={`bg-white p-4 rounded-2xl shadow-sm border border-amber-50 flex justify-between items-center group animate-fade-in-up stagger-${(index % 5) + 1} hover:shadow-md transition-shadow`}>
                                    <div>
                                        <div className="font-bold text-gray-800 flex items-center gap-2">{record.item}</div>
                                        <div className="text-xs text-amber-500 font-medium">{record.date}</div>
                                        <div className="text-xs text-gray-400">{record.categoryName}</div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="font-bold text-lg text-gray-800">${formatNumber(record.amount)}</span>
                                        <button onClick={() => onDelete(record)} className="text-gray-200 hover:text-red-400 p-2 transition-colors"><Icons.Trash /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // ç¨ç«‹å‡ºä¾†çš„ BudgetView
        const BudgetView = ({ categories, currentMonth, isLoading, onRefresh, onEdit, onUpdateCategory, onDeleteCategory, onAddCategory }) => {
            const renderCategories = () => {
                const groups = {};
                const standalone = [];

                categories.forEach(cat => {
                    if (cat.group) {
                        if (!groups[cat.group]) groups[cat.group] = { name: cat.group, items: [], totalBudget: 0, totalSpent: 0 };
                        groups[cat.group].items.push(cat);
                        // ã€ä¿®æ­£ã€‘ä½¿ç”¨ (Number(cat.budget) || 0) ç¢ºä¿ç©ºå­—ä¸²ä¸æœƒå°è‡´è¨ˆç®—éŒ¯èª¤
                        groups[cat.group].totalBudget += (Number(cat.budget) || 0);
                        groups[cat.group].totalSpent += cat.spent;
                    } else {
                        standalone.push(cat);
                    }
                });

                const elements = [];

                Object.values(groups).forEach((group, groupIdx) => {
                    const remaining = group.totalBudget - group.totalSpent;
                    elements.push(
                        <div key={`group-${group.name}`} className={`mb-4 bg-white rounded-2xl shadow-sm border border-amber-100 overflow-hidden animate-fade-in-up stagger-${(groupIdx % 5) + 1} hover:shadow-md transition-shadow`}>
                            <div className="bg-amber-50/50 p-3 flex justify-between items-center border-b border-amber-100">
                                <div className="flex items-center gap-2">
                                    <div className="text-amber-500"><Icons.Folder /></div>
                                    <div className="font-bold text-amber-900">{group.name}</div>
                                </div>
                                <div className="text-right">
                                    <span className={`font-bold ${remaining < 0 ? 'text-red-500' : 'text-amber-700'}`}>${formatNumber(remaining)}</span>
                                    <span className="text-xs text-amber-400 ml-1">/ ${formatNumber(group.totalBudget)}</span>
                                </div>
                            </div>
                            <div className="divide-y divide-gray-100">
                                {group.items.map((item, idx) => (
                                    <div key={item.id} className="p-3 pl-6 flex justify-between items-center bg-white hover:bg-gray-50 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className="w-2 h-2 rounded-full" style={{ background: COLORS[idx % COLORS.length] }}></div>
                                            <div>
                                                <div className="font-medium text-gray-700 text-sm">{item.name}</div>
                                                {/* é€™è£¡ä¸å†é¡¯ç¤ºé ç®—ï¼Œåªé¡¯ç¤ºèŠ±è²» */}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-xs text-gray-400 mr-1">èŠ±è²»</span>
                                            <span className="font-bold text-gray-700">${formatNumber(item.spent)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                });

                standalone.forEach((item, idx) => {
                    const remaining = item.budget - item.spent;
                    elements.push(
                        <div key={item.id} className={`bg-white rounded-2xl p-4 shadow-sm border border-amber-100 flex justify-between items-center relative overflow-hidden mb-3 animate-fade-in-up stagger-${((Object.keys(groups).length + idx) % 5) + 1} hover:shadow-md transition-shadow`}>
                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 opacity-80`} style={{ background: COLORS[idx % COLORS.length] }}></div>
                            <div className="flex items-center gap-3 pl-2">
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm" style={{ background: COLORS[idx % COLORS.length] }}>{item.name[0]}</div>
                                <div><div className="font-bold text-gray-800">{item.name}</div><div className="text-xs text-gray-400">å·²èŠ± ${formatNumber(item.spent)}</div></div>
                            </div>
                            <div className="text-right"><div className={`font-bold text-lg ${remaining < 0 ? 'text-red-500' : 'text-gray-800'}`}>${formatNumber(remaining)}</div><div className="text-xs text-gray-400">/ ${formatNumber(item.budget)}</div></div>
                        </div>
                    );
                });

                return elements;
            };

            return (
                <div className="space-y-3 pb-24 p-4 overflow-y-auto h-full">
                    {isLoading && <div className="text-center p-2 text-amber-600 text-xs animate-pulse">æ­£åœ¨è®€å– {currentMonth} è³‡æ–™...</div>}

                    <div className="bg-amber-400 rounded-3xl p-5 text-white shadow-lg mb-6 relative overflow-hidden transition-all animate-fade-in-up">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl -mr-10 -mt-10"></div>

                        <div className="flex justify-between items-start mb-5 relative z-10">
                            <div className="flex items-center gap-1 bg-white/20 px-2 py-1.5 rounded-xl backdrop-blur-md border border-white/20 hover:bg-white/30 transition-colors">
                                <span className="text-amber-50 text-xs">ğŸ“…</span>
                                <input type="month" value={currentMonth} onChange={onRefresh} className="bg-transparent text-white text-sm font-bold outline-none border-none p-0 w-[110px] cursor-pointer placeholder-white" />
                            </div>
                            <button onClick={onRefresh} className="text-amber-50 hover:text-white hover:rotate-90 transition-transform bg-white/10 p-2 rounded-full backdrop-blur-sm shadow-sm flex-shrink-0"><Icons.Refresh /></button>
                        </div>

                        <div className="relative z-10">
                            <div className="text-amber-100 text-xs font-bold mb-1 tracking-wider">æœ¬æœˆå‰©é¤˜é ç®—</div>
                            {/* ã€ä¿®æ­£ã€‘è¨ˆç®—ç¸½å‰©é¤˜æ™‚åŠ å…¥é˜²å‘†ï¼Œé¿å…ç©ºé ç®—å°è‡´ NaN */}
                            <div className="text-4xl font-bold tracking-tight text-white drop-shadow-sm">${formatNumber(categories.reduce((acc, c) => acc + ((Number(c.budget) || 0) - c.spent), 0))}</div>
                        </div>

                        <div className="h-3 bg-black/10 rounded-full overflow-hidden flex p-0.5 mt-4 relative z-10">
                            {categories.map((c, i) => <div key={c.id} style={{ width: `${(c.spent / Math.max(1, categories.reduce((s, x) => s + (Number(x.budget) || 0), 0))) * 100}%`, background: COLORS[i % COLORS.length] }} className="h-full rounded-full transition-all duration-500" />)}
                        </div>
                    </div>

                    {renderCategories()}

                    <div className="text-center pt-2 pb-8 animate-fade-in-up stagger-5">
                        {isLoading ? (
                            <span className="text-amber-400 text-sm flex items-center justify-center gap-2 mx-auto bg-amber-50 py-2 px-4 rounded-full w-fit"><Icons.Refresh /> åŒæ­¥è³‡æ–™ä¸­...</span>
                        ) : (
                            <button onClick={onEdit} className="text-amber-500 font-medium text-sm flex items-center justify-center gap-1.5 mx-auto bg-white py-2 px-4 rounded-full shadow-sm border border-amber-100 hover:bg-amber-50 hover:text-amber-600 transition-all active:scale-95"><Icons.Edit /> ç·¨è¼¯é¡åˆ¥èˆ‡é ç®—</button>
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('budget');
            const [isLoading, setIsLoading] = useState(false);
            const [categories, setCategories] = useState([]);
            const [history, setHistory] = useState([]); // åˆå§‹åŒ–ç‚ºç©ºé™£åˆ—
            const [currentMonth, setCurrentMonth] = useState(() => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            });

            const [input, setInput] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [lastLog, setLastLogState] = useState(null);

            // è¦†å¯« setLastLogï¼ŒåŠ ä¸Š 3.5 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±çš„æ©Ÿåˆ¶
            const setLastLog = (logObj) => {
                setLastLogState(logObj);
                if (logObj) {
                    setTimeout(() => {
                        // æª¢æŸ¥å¦‚æœç›®å‰çš„ log é‚„æ˜¯åŸæœ¬é‚£ä¸€å€‹ï¼Œæ‰æŠŠå®ƒæ¸…æ‰ï¼ˆé¿å…æ¸…åˆ°å¾Œä¾†æ–°å½ˆå‡ºçš„è¨Šæ¯ï¼‰
                        setLastLogState(prev => prev === logObj ? null : prev);
                    }, 3500);
                }
            };

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('budget-settings-v5');
                return saved ? JSON.parse(saved) : {
                    apiKey: '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',
                    provider: 'openai',
                    model: 'gpt-5-mini'
                };
            });

            useEffect(() => { localStorage.setItem('budget-settings-v5', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { loadDataFromCloud(currentMonth); }, [currentMonth]);

            // --- Cloud API Wrapper ---
            const callBackend = async (action, payload = {}) => {
                if (!GOOGLE_SCRIPT_URL) throw new Error("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š Google Script URL");
                const body = JSON.stringify({ action, ...payload });
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: body
                });
                if (!response.ok) throw new Error("ç¶²è·¯é€£ç·šéŒ¯èª¤");
                const json = await response.json();
                if (json.status === 'error') throw new Error(json.message || "Unknown API Error");
                return json;
            };

            const loadDataFromCloud = async (monthToLoad) => {
                setIsLoading(true);
                try {
                    const data = await callBackend('getData', { month: monthToLoad });
                    if (data) {
                        setCategories(data.categories || []);
                        setHistory(data.history || []); // å¼·åˆ¶çµ¦äºˆç©ºé™£åˆ—ï¼Œé˜²æ­¢ undefined
                        setLastLog({ msg: `å·²è®€å– ${monthToLoad} è³‡æ–™`, type: 'success' });
                    }
                } catch (err) {
                    console.error(err);
                    setLastLog({ msg: "è®€å–å¤±æ•—: " + err.message, type: 'error' });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleMonthChange = (e) => {
                // å€åˆ†æ˜¯æ›´æ”¹æœˆä»½é‚„æ˜¯é»æ“Šæ›´æ–°æŒ‰éˆ•
                if (e && e.target && e.target.tagName === 'INPUT') {
                    setCurrentMonth(e.target.value);
                } else {
                    // å¦‚æœæ˜¯é»æ“Šé‡æ•´æŒ‰éˆ•ï¼Œç›´æ¥å¼·åˆ¶æ›´æ–°ç•¶å‰æœˆä»½è³‡æ–™
                    loadDataFromCloud(currentMonth);
                }
            };

            const saveCategoriesToCloud = async (newCategories) => {
                setCategories(newCategories);
                try {
                    // å°‡ç•¶å‰æœˆä»½ä¹Ÿå‚³é€éå»ï¼Œè®“å¾Œç«¯å¯ä»¥ç¨ç«‹å„²å­˜
                    await callBackend('saveConfig', { categories: newCategories, month: currentMonth });
                    setLastLog({ msg: `${currentMonth} çš„é¡åˆ¥è¨­å®šå·²å„²å­˜`, type: 'success' });
                } catch (e) {
                    setLastLog({ msg: "å„²å­˜è¨­å®šå¤±æ•—: " + e.message, type: 'error' });
                }
            };

            const deleteTransaction = async (record) => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${record.item} $${record.amount}ã€å—ï¼Ÿ`)) return;
                const targetCat = categories.find(c => c.id === record.categoryId);
                if (targetCat) {
                    const newCats = categories.map(c => c.id === record.categoryId ? { ...c, spent: c.spent - record.amount } : c);
                    setCategories(newCats);
                }
                setHistory(prev => prev.filter(r => r.id !== record.id));
                try {
                    const res = await callBackend('deleteData', { id: record.id });
                    if (res.status === 'deleted') setLastLog({ msg: "åˆªé™¤æˆåŠŸ", type: 'success' });
                } catch (e) { setLastLog({ msg: "åˆªé™¤å¤±æ•—: " + e.message, type: 'error' }); }
            };

            const processInput = async (e) => {
                e.preventDefault();
                if (!input.trim() || isProcessing || isLoading) return;
                setIsProcessing(true); setLastLog(null);

                try {
                    // ä¿®å¾©ï¼šä¸ä½¿ç”¨ toISOString å› ç‚ºåœ¨å°ç£æ—©ä¸Š 8 é»å‰æœƒè·¨æ—¥è®Šæ˜¨å¤©
                    const now = new Date();
                    const currentDate = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}`;

                    const result = await callBackend('analyze', { text: input, categories: categories, currentDate: currentDate });

                    if (!result || !result.data || !result.data.transactions || result.data.transactions.length === 0) {
                        throw new Error("ç„¡æ³•è¾¨è­˜ä»»ä½•äº¤æ˜“");
                    }

                    const transactions = result.data.transactions;
                    let newHistoryItems = [];
                    let updatedCategories = [...categories];
                    let hasNewCategory = false;

                    const needsOther = transactions.some(t => t.categoryId === 'OTHER' || !updatedCategories.find(c => c.id === t.categoryId));
                    let otherCategory = updatedCategories.find(c => c.name === 'å…¶ä»–');

                    if (needsOther && !otherCategory) {
                        otherCategory = { id: Date.now().toString(), name: 'å…¶ä»–', budget: 0, spent: 0, group: '' };
                        updatedCategories.push(otherCategory);
                        hasNewCategory = true;
                    }

                    const apiPromises = []; // ç”¨æ–¼æ”¶é›†æ‰€æœ‰å‘¼å«

                    for (const tx of transactions) {
                        let targetCat = updatedCategories.find(c => c.id === tx.categoryId);
                        if (!targetCat) targetCat = updatedCategories.find(c => c.name.includes(tx.item));
                        if (!targetCat && otherCategory) targetCat = otherCategory;
                        if (!targetCat) continue;

                        targetCat.spent += tx.amount;

                        const txDate = tx.date || currentDate.replace(/\//g, '-');
                        const recordId = Math.random().toString(36).substr(2, 9) + Date.now().toString();
                        const txDateNormalized = txDate.replace(/\//g, '-');

                        if (txDateNormalized.startsWith(currentMonth)) {
                            const displayDate = txDate.replace(/-/g, '/');
                            newHistoryItems.push({
                                id: recordId, date: displayDate, rawDate: txDate, month: currentMonth,
                                item: tx.item, amount: tx.amount, categoryId: targetCat.id, categoryName: targetCat.name, note: ''
                            });
                        }

                        const txMonth = txDate.slice(0, 7);
                        // å°‡æ‰€æœ‰å‚³é€ API çš„ Promise æ”¶é›†èµ·ä¾†
                        apiPromises.push(callBackend('addData', { date: txDate, month: txMonth, category: targetCat.name, item: tx.item, amount: tx.amount, note: '', id: recordId }));
                    }

                    setCategories(updatedCategories);
                    setHistory(prev => [...newHistoryItems, ...prev].slice(0, 100));
                    if (hasNewCategory) saveCategoriesToCloud(updatedCategories);

                    // ä¿®å¾©ï¼šç­‰å¾…æ‰€æœ‰æ–°å¢å‹•ä½œå®Œæˆï¼Œè‹¥æœ‰å¤±æ•—çµ¦äºˆæç¤º
                    const apiResults = await Promise.allSettled(apiPromises);
                    const failedCount = apiResults.filter(r => r.status === 'rejected').length;

                    const totalAmount = transactions.reduce((acc, cur) => acc + cur.amount, 0);

                    if (failedCount > 0) {
                        setLastLog({ msg: `è¨˜å¸³å®Œæˆï¼Œä½†æœ‰ ${failedCount} ç­†é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œè«‹é‡æ•´ç•«é¢ï¼`, type: 'error' });
                    } else {
                        setLastLog({ msg: `è¨˜å¸³æˆåŠŸï¼å…± ${transactions.length} ç­† ($${totalAmount})`, type: 'success' });
                    }

                    setInput('');

                } catch (error) {
                    console.error(error);
                    setLastLog({ msg: error.message || "ç™¼ç”ŸéŒ¯èª¤", type: 'error' });
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-amber-50 max-w-md mx-auto shadow-2xl relative">
                    <div className="flex-1 overflow-hidden relative">
                        {view === 'budget' && <BudgetView
                            categories={categories}
                            currentMonth={currentMonth}
                            isLoading={isLoading}
                            onRefresh={handleMonthChange}
                            onEdit={() => setIsEditing(true)}
                        />}
                        {view === 'history' && <HistoryView
                            history={history}
                            currentMonth={currentMonth}
                            onDelete={deleteTransaction}
                        />}
                        {view === 'stats' && <div className="p-4 h-full flex flex-col items-center"><h2 className="text-xl font-bold mb-4 w-full px-2 text-amber-900 flex items-center gap-2"><span>ğŸ“Š</span> {currentMonth} çµ±è¨ˆ</h2><SimplePieChart data={categories.filter(c => c.spent > 0).map(c => ({ name: c.name, value: c.spent }))} /></div>}

                        {isEditing && view === 'budget' && (
                            <div className="absolute inset-0 bg-white/95 z-10 p-4 overflow-y-auto backdrop-blur-sm">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg text-amber-800">ç·¨è¼¯ {currentMonth} é¡åˆ¥èˆ‡é ç®—</h3>
                                    <button onClick={() => { setIsEditing(false); saveCategoriesToCloud(categories); }} className="text-amber-600 font-bold bg-amber-100 px-3 py-1 rounded-full">å„²å­˜ä¸¦å®Œæˆ</button>
                                </div>
                                {categories.map(c => (
                                    <div key={c.id} className="flex gap-2 mb-3 bg-amber-50 p-2 rounded-xl border border-amber-100 items-center">
                                        <div className="flex-1">
                                            <div className="flex gap-2 mb-1">
                                                <input value={c.name} onChange={e => setCategories(cats => cats.map(x => x.id === c.id ? { ...x, name: e.target.value } : x))} className="bg-transparent border-b border-amber-200 p-1 w-full outline-none text-amber-900 placeholder-amber-300 font-bold" placeholder="åç¨±" />
                                                {/* ã€ä¿®æ­£ã€‘è¼¸å…¥æ™‚å…è¨±ç©ºå­—ä¸²ï¼Œé˜²æ­¢åˆªé™¤æ•¸å­—æ™‚è‡ªå‹•è·³å› 0 */}
                                                <input type="number" value={c.budget} onChange={e => setCategories(cats => cats.map(x => x.id === c.id ? { ...x, budget: e.target.value === '' ? '' : Number(e.target.value) } : x))} className="bg-transparent border-b border-amber-200 p-1 w-20 text-center outline-none text-amber-900 font-mono" />
                                            </div>
                                            <input value={c.group || ''} onChange={e => setCategories(cats => cats.map(x => x.id === c.id ? { ...x, group: e.target.value } : x))} className="bg-transparent text-xs text-gray-500 p-1 w-full outline-none placeholder-gray-300" placeholder="ç¾¤çµ„ (ä¾‹å¦‚: è®Šå‹•è²»)" />
                                        </div>
                                        <button onClick={() => { if (confirm('åˆªé™¤é€™å€‹é¡åˆ¥?')) setCategories(cats => cats.filter(x => x.id !== c.id)) }} className="text-red-400 p-2 hover:bg-red-50 rounded-full h-fit"><Icons.Trash /></button>
                                    </div>
                                ))}
                                <button onClick={() => setCategories([...categories, { id: Date.now().toString(), name: 'æ–°é¡åˆ¥', budget: 1000, spent: 0, group: '' }])} className="w-full py-3 border-2 border-dashed border-amber-300 rounded-xl text-amber-400 mt-4 hover:bg-amber-50 transition-colors font-bold flex items-center justify-center gap-2"><Icons.Plus /> æ–°å¢é¡åˆ¥</button>
                            </div>
                        )}
                    </div>

                    {view === 'budget' && !isEditing && (
                        <div className="absolute bottom-24 left-0 right-0 px-4">
                            {lastLog && <div className={`text-xs mb-3 px-4 py-2.5 rounded-xl w-fit shadow-md max-w-full font-medium border animate-bounce-slight ${lastLog.type === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>{lastLog.msg}</div>}
                            <form onSubmit={processInput} className="glass-panel p-2 rounded-[24px] shadow-lg flex items-center gap-2">
                                <div className="p-2 text-amber-500 animate-pulse"><Icons.Sparkles /></div>
                                <input value={input} onChange={e => setInput(e.target.value)} disabled={isProcessing || isLoading} placeholder={isLoading ? "åŒæ­¥è³‡æ–™ä¸­..." : "è¼¸å…¥: æ—©é¤65, æ·é‹25..."} className="flex-1 outline-none text-gray-700 placeholder-gray-400 font-medium bg-transparent py-2" />
                                <button disabled={!input || isProcessing || isLoading} className="bg-amber-500 text-white p-3.5 rounded-[20px] disabled:opacity-50 hover:bg-amber-600 transition-all active:scale-90 shadow-md shadow-amber-200/50">
                                    {isProcessing ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Icons.Send />}
                                </button>
                            </form>
                        </div>
                    )}

                    <div className="glass-panel border-t-0 p-2 flex justify-around items-center z-20 pb-safe rounded-t-[32px] mx-2 mb-2 shadow-[0_-8px_30px_rgba(251,191,36,0.1)]">
                        <button onClick={() => setView('budget')} className={`py-3 px-6 rounded-2xl flex flex-col items-center gap-1.5 transition-all duration-300 ${view === 'budget' ? 'text-amber-600 bg-amber-100 scale-105 font-bold shadow-sm' : 'text-gray-400 hover:bg-white/50'}`}><Icons.Home /> <span className="text-[10px]">è¨˜å¸³</span></button>
                        <button onClick={() => setView('history')} className={`py-3 px-6 rounded-2xl flex flex-col items-center gap-1.5 transition-all duration-300 ${view === 'history' ? 'text-amber-600 bg-amber-100 scale-105 font-bold shadow-sm' : 'text-gray-400 hover:bg-white/50'}`}><Icons.List /> <span className="text-[10px]">ç´€éŒ„</span></button>
                        <button onClick={() => setView('stats')} className={`py-3 px-6 rounded-2xl flex flex-col items-center gap-1.5 transition-all duration-300 ${view === 'stats' ? 'text-amber-600 bg-amber-100 scale-105 font-bold shadow-sm' : 'text-gray-400 hover:bg-white/50'}`}><Icons.PieChart /> <span className="text-[10px]">çµ±è¨ˆ</span></button>
                    </div>

                    {showSettings && (
                        <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full rounded-3xl p-6 shadow-2xl">
                                <h2 className="font-bold text-lg mb-4 text-amber-900 flex items-center gap-2"><Icons.Settings /> è¨­å®š</h2>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-amber-500 ml-1">AI API Key (å·²å¯«æ­»)</label>
                                        <input type="password" value={settings.apiKey} readOnly className="w-full border-2 border-gray-100 bg-gray-50 p-2 rounded-xl outline-none text-gray-400 cursor-not-allowed" />
                                    </div>

                                    <div className="bg-amber-50 p-3 rounded-xl border border-amber-100">
                                        <label className="text-xs font-bold text-amber-500 block mb-2">AI é¸æ“‡</label>
                                        <div className="flex gap-2 mb-2">
                                            <button onClick={() => setSettings(s => ({ ...s, provider: 'gemini' }))} className={`flex-1 p-2 rounded-lg text-xs font-bold transition-colors ${settings.provider === 'gemini' ? 'bg-amber-400 text-white shadow-md' : 'bg-white text-gray-400 border border-gray-100'}`}>Gemini</button>
                                            <button onClick={() => setSettings(s => ({ ...s, provider: 'openai' }))} className={`flex-1 p-2 rounded-lg text-xs font-bold transition-colors ${settings.provider === 'openai' ? 'bg-green-500 text-white shadow-md' : 'bg-white text-gray-400 border border-gray-100'}`}>OpenAI</button>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setShowSettings(false)} className="w-full bg-amber-500 text-white p-3 rounded-xl font-bold shadow-lg shadow-amber-200">å®Œæˆ</button>
                            </div>
                        </div>
                    )}

                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>
